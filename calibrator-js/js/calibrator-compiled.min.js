"use strict";function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function mandatory(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];throw new Error("Missing parameter "+t)}function findAllIndices(){for(var t=arguments.length<=0||void 0===arguments[0]?mandatory():arguments[0],e=arguments.length<=1||void 0===arguments[1]?mandatory():arguments[1],i=[],a=0;a<e.length;a++)e.substr(a,t.length)===t&&i.push(a);return i.length?i:-1}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),scripts=document.getElementsByTagName("script"),calibratorFullpath=scripts[scripts.length-1].src,delimiterIndices=findAllIndices("/",calibratorFullpath);calibratorFullpath=calibratorFullpath.substr(0,delimiterIndices[delimiterIndices.length-2]),document.addEventListener("DOMContentLoaded",function(t){var e=document.getElementsByTagName("head")[0],i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.href=calibratorFullpath+"/css/calibrator.css",e.appendChild(i)});var Calibrator=function(){function t(){var e,i=arguments.length<=0||void 0===arguments[0]?null:arguments[0],a=arguments.length<=1||void 0===arguments[1]||arguments[1];if(_classCallCheck(this,t),"undefined"==typeof calibratorFullpath)throw new Error("Calibrator.js: library path is unknown.");if(this.calibratorFullpath=calibratorFullpath,"function"!=typeof _)throw new Error("Calibrator.js: Underscore.js is needed for templating.");this.VIEWS_PATHS={container:this.calibratorFullpath+"/views/calibrator-container.template",knownsize:this.calibratorFullpath+"/views/calibrator-s1-knownsize.template",enterknownsize:this.calibratorFullpath+"/views/calibrator-s1-enterknownsize.template",chooseobject:this.calibratorFullpath+"/views/calibrator-s1-chooseobject.template",specifystandardsize:this.calibratorFullpath+"/views/calibrator-s1-specifystandardsize.template",setbrightness:this.calibratorFullpath+"/views/calibrator-s2-content.template",summary:this.calibratorFullpath+"/views/calibrator-s3-content.template"};var n=this;this.templateManager=new TemplateManager(this.VIEWS_PATHS,function(){n.templatesAreLoaded()}),this.IMAGE_KEY_CREDITCARD="creditCard",this.IMAGE_KEY_CD="cd",this.IMAGES=(e={},_defineProperty(e,this.IMAGE_KEY_CREDITCARD,[this.calibratorFullpath+"/img/card.png",[384,242],8.6,1.2]),_defineProperty(e,this.IMAGE_KEY_CD,[this.calibratorFullpath+"/img/cd.png",[596,596],12,1.2]),e),this.distanceFromScreen=50,this.canvasHeight=400,this.BRIGHTNESS_NUMBER_OF_CONTRASTS=12,this.cachedImages={},this.preloadImages(),this.STEP_TITLES=["Step 1: Screen size calibration","Step 2: Contrast and brightness","Step 3: Summary"],this.STEP_SCREENSIZE_ASK_IFKNOWS=0,this.STEP_SCREENSIZE_ENTER_KNOWNSIZE=1,this.STEP_SCREENSIZE_CHOOSE_OBJECT=2,this.STEP_SCREENSIZE_ENTER_OBJECTSIZE=3,this.STEP_BRIGHTNESS=4,this.STEP_SUMMARY=5,this.BUTTON_SIZEKNOWN="s1:sizeKnown",this.BUTTON_SIZEUNKNOWN="s1:sizeUnknown",this.BUTTON_CONFIRM_MANUALSIZE="s1:confirmManualSize",this.BUTTON_CHOOSE_CREDITCARD="s1:chooseCreditCard",this.BUTTON_CHOOSE_COMPACTDISK="s1:chooseCompactDisk",this.BUTTON_CONFIRM_OBJECTSIZE="s1:confirmObjectSize",this.BUTTON_CONFIRM_BRIGHTNESS="s2:confirmBrightness",this.BUTTON_FINAL_CONFIRM="s3:finalConfirm",this.BUTTON_BACK="back",this.currentStep=this.STEP_SCREENSIZE_ASK_IFKNOWS,this.FLOAT_PRECISION=2,this._diagonalSize=null,this._currentImage=null,this._imageRatio=.5,this._showWhenReady=1==a,this.callbackWhenClosed=null,i?this.callbackWhenClosed=i:console.log("Calibrator.js: no callback is set-up for the calibrator to call when finished!"),$(window).resize(function(){this.canvasResized()})}return _createClass(t,[{key:"preloadImages",value:function(){for(var t in this.IMAGES)this.cachedImages[t]=new Image,this.cachedImages[t].src=this.IMAGES[t][0]}},{key:"templatesAreLoaded",value:function(){console.log("Calibrator.js : All templates are loaded"),this.addToDom(),this.container=$(".calibrator-container"),$(this.container).toggle(this._showWhenReady),this.resetEvents()}},{key:"addToDom",value:function(){this.templateManager.renderInTarget("container",{title:this.currentTitle,content:this.currentContent},"body")}},{key:"show",value:function(){$(this.container).fadeIn(200)}},{key:"hide",value:function(){$(this.container).fadeOut(200)}},{key:"toggle",value:function(){$(this.container).toggle(200)}},{key:"toggleInfo",value:function(){$(".calibrator-info-content").toggle(200)}},{key:"updateView",value:function(){var t=this;this.updateGuide(),$(".calibrator-title").animate({opacity:0},300,function(){$(".calibrator-title").html("<h3>"+t.currentTitle+"</h3>"),$(".calibrator-title").animate({opacity:300},100)}),$(".calibrator-content").animate({opacity:0},300,function(){$(".calibrator-content").html(t.currentContent),t.setStepLogic(),t.currentStep!=t.STEP_SCREENSIZE_ASK_IFKNOWS&&t.addBackButton(),$(".calibrator-content").animate({opacity:300},100,function(){t.resetEvents()})})}},{key:"updateGuide",value:function(){if($(".calibrator-guide").length)switch(_.each($(".calibrator-guide div"),function(t){$(t).removeClass("calibrator-guide-active")}),this.currentStep){case this.STEP_SCREENSIZE_ASK_IFKNOWS:case this.STEP_SCREENSIZE_ENTER_KNOWNSIZE:case this.STEP_SCREENSIZE_CHOOSE_OBJECT:case this.STEP_SCREENSIZE_ENTER_OBJECTSIZE:$("#calibrator-guide-step1").addClass("calibrator-guide-active");break;case this.STEP_BRIGHTNESS:$("#calibrator-guide-step2").addClass("calibrator-guide-active");break;case this.STEP_SUMMARY:$("#calibrator-guide-step3").addClass("calibrator-guide-active")}else console.log("Calibrator.js: calibrator-guide div not in the dom.")}},{key:"resetEvents",value:function(){$(".calibrator-info-icon").off(),$(".calibrator-dismiss-icon").off(),$(".calibrator-button").off(),$(".calibrator-size-range").off();var t=this;$(".calibrator-info-icon").on("click",function(e){t.toggleInfo()}),$(".calibrator-dismiss-icon").on("click",function(e){t.callbackNow(0),t.hide()}),$(".calibrator-button").on("click",function(e){t.buttonClicked(e)}),$(".calibrator-size-range").on("change",function(e){t.setRatioFromRange($(e.target)),t.drawImage(),t.updateSummaryInformation()})}},{key:"goToStep",value:function(t){this.currentStep=t,this.updateView()}},{key:"setStepLogic",value:function(){switch(this.currentStep){case this.STEP_SCREENSIZE_ENTER_KNOWNSIZE:$.isNumeric(this.diagonalSize)?$("#calibrator-monitor-size")[0].value=this.diagonalSize.toFixed(this.FLOAT_PRECISION):this.diagonalSize=null;break;case this.STEP_SCREENSIZE_CHOOSE_OBJECT:break;case this.STEP_SCREENSIZE_ENTER_OBJECTSIZE:this.setRangeFromRatio(),this.setDiagonalSizeFromRatio(),this.drawImage(),this.updateSummaryInformation();break;case this.STEP_BRIGHTNESS:this.drawGrayScale(),console.log(this.pixelsPerDegree);break;case this.STEP_SUMMARY:}}},{key:"goToPreviousStep",value:function(){switch(this.currentStep){case this.STEP_SCREENSIZE_ENTER_KNOWNSIZE:this.goToStep(this.STEP_SCREENSIZE_ASK_IFKNOWS);break;case this.STEP_SCREENSIZE_CHOOSE_OBJECT:this.goToStep(this.STEP_SCREENSIZE_ASK_IFKNOWS);break;case this.STEP_SCREENSIZE_ENTER_OBJECTSIZE:this.goToStep(this.STEP_SCREENSIZE_CHOOSE_OBJECT);break;case this.STEP_BRIGHTNESS:this.goToStep(this.STEP_SCREENSIZE_ASK_IFKNOWS);break;case this.STEP_SUMMARY:this.goToStep(this.STEP_BRIGHTNESS)}}},{key:"addBackButton",value:function(){if($(".calibrator-backdiv").length){var t='<button class="btn calibrator-button calibrator-button-back" value="back">Back</button>';$(".calibrator-backdiv").append(t)}else{var t='<div class="col-xs-12 calibrator-spacing"></div><div class="col-xs-12 "><button class="btn calibrator-button calibrator-button-back" value="back">Back</button></div>';$(".calibrator-content").append(t)}}},{key:"buttonClicked",value:function(t){var e=t.target.value;switch(e){case this.BUTTON_SIZEKNOWN:this.goToStep(this.STEP_SCREENSIZE_ENTER_KNOWNSIZE);break;case this.BUTTON_SIZEUNKNOWN:this.goToStep(this.STEP_SCREENSIZE_CHOOSE_OBJECT);break;case this.BUTTON_CONFIRM_MANUALSIZE:$.isNumeric($("#calibrator-monitor-size")[0].value)?(this.diagonalSize=Number($("#calibrator-monitor-size")[0].value),this.goToStep(this.STEP_BRIGHTNESS)):console.log("Calibrator.js: monitor size is invalid");break;case this.BUTTON_CHOOSE_CREDITCARD:this._currentImage=this.IMAGE_KEY_CREDITCARD,this.updateCanvasHeight(),this.goToStep(this.STEP_SCREENSIZE_ENTER_OBJECTSIZE);break;case this.BUTTON_CHOOSE_COMPACTDISK:this._currentImage=this.IMAGE_KEY_CD,this.updateCanvasHeight(),this.goToStep(this.STEP_SCREENSIZE_ENTER_OBJECTSIZE);break;case this.BUTTON_CONFIRM_OBJECTSIZE:this.goToStep(this.STEP_BRIGHTNESS);break;case this.BUTTON_CONFIRM_BRIGHTNESS:this.goToStep(this.STEP_SUMMARY);break;case this.BUTTON_FINAL_CONFIRM:this.callbackNow(1),this.hide();break;case this.BUTTON_BACK:this.goToPreviousStep()}}},{key:"updateSummaryInformation",value:function(){var t=this;$(".calibrator-diagonal-size-inches").length&&_.each($(".calibrator-diagonal-size-inches"),function(e){$(e).html(t.diagonalSize.toFixed(t.FLOAT_PRECISION)+" inches")})}},{key:"callbackNow",value:function(t){var e={status:0,diagonalSize:null,diagonalSizeInPx:this.diagonalSizeInPx,distanceFromScreenInCm:null,pixelsPerInch:null,pixelsPerDegree:null};this.diagonalSize&&(e.status=t,e.diagonalSize=this.diagonalSize,e.distanceFromScreenInCm=this.distanceFromScreen,e.pixelsPerInch=this.pixelsPerInch,e.pixelsPerDegree=this.pixelsPerDegree),this.callbackWhenClosed?this.callbackWhenClosed(e):(console.log("Calibrator.js: Has been dismisse "),console.log(e))}},{key:"updateCanvasHeight",value:function(){if(this.currentImage){var t=this.IMAGES[this.currentImage][1][1]*this.IMAGES[this.currentImage][3];this.canvasHeight=t+50}}},{key:"fitCanvasToContainer",value:function(){if($(".calibrator-canvas").length){var t=$(".calibrator-canvas")[0];t.style.width="100%",t.style.height=this.canvasHeight+"px",t.width=t.offsetWidth,t.height=t.offsetHeight}}},{key:"canvasResized",value:function(){switch(this.fitCanvasToContainer(),this.currentStep){case this.STEP_SCREENSIZE_ENTER_OBJECTSIZE:this.setDiagonalSizeFromRatio(),this.drawImage();break;case this.STEP_BRIGHTNESS:this.drawGrayScale()}}},{key:"drawImage",value:function(){if($(".calibrator-canvas").length&&this.currentStep==this.STEP_SCREENSIZE_ENTER_OBJECTSIZE){this.fitCanvasToContainer();var t=$(".calibrator-canvas")[0],e=t.getContext("2d");e.clearRect(0,0,t.width,t.height);var i=(t.width-this.currentImageScaledWidthInPx)/2,a=(t.height-this.currentImageScaledHeightInPx)/2;e.drawImage(this.cachedImages[this._currentImage],i,a,this.currentImageScaledWidthInPx,this.currentImageScaledHeightInPx)}}},{key:"setRatioFromRange",value:function(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];if(null==t&&(t=$(".calibrator-size-range")),$(t).length){var e=Number($(t).attr("max"))-Number($(t).attr("min")),i=Number($(t).val());this.imageRatio=i/e}}},{key:"setRangeFromRatio",value:function(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];if(null==t&&(t=$(".calibrator-size-range")),$(t).length){var e=Number($(t).attr("max"))-Number($(t).attr("min"));$(t).val(this.imageRatio*e+Number($(t).attr("min")))}}},{key:"setDiagonalSizeFromRatio",value:function(){this.currentImage&&(this.diagonalSize=this.diagonalSizeInPx/(this.currentImageScaledWidthInPx/this.currentImagePhysicalWidthInInches))}},{key:"drawGrayScale",value:function(){if(!$(".calibrator-canvas").length||this.currentStep!=this.STEP_BRIGHTNESS)throw new Error("Calibrator.js: the canvas element is not present, cannot drawImage().");this.fitCanvasToContainer();var t=$(".calibrator-canvas")[0],e=t.getContext("2d");e.clearRect(0,0,t.width,t.height);for(var i=30,a=150,n=Math.round(t.width/2),r=Math.round(t.height/2),s=n-i*this.BRIGHTNESS_NUMBER_OF_CONTRASTS/2,o=r-a/2,c=0;c<this.BRIGHTNESS_NUMBER_OF_CONTRASTS;c++){var l=Math.round(c*(255/(this.BRIGHTNESS_NUMBER_OF_CONTRASTS-1)));e.fillStyle="rgb("+l+","+l+","+l+")",e.fillRect(s+c*i,o,i,a)}}},{key:"currentTitle",get:function(){switch(this.currentStep){case this.STEP_SCREENSIZE_ASK_IFKNOWS:return this.STEP_TITLES[0];case this.STEP_SCREENSIZE_ENTER_KNOWNSIZE:return this.STEP_TITLES[0];case this.STEP_SCREENSIZE_CHOOSE_OBJECT:return this.STEP_TITLES[0];case this.STEP_SCREENSIZE_ENTER_OBJECTSIZE:return this.STEP_TITLES[0];case this.STEP_BRIGHTNESS:return this.STEP_TITLES[1];case this.STEP_SUMMARY:return this.STEP_TITLES[2]}}},{key:"currentContent",get:function(){switch(this.currentStep){case this.STEP_SCREENSIZE_ASK_IFKNOWS:return this.templateManager.render("knownsize");case this.STEP_SCREENSIZE_ENTER_KNOWNSIZE:return this.templateManager.render("enterknownsize");case this.STEP_SCREENSIZE_CHOOSE_OBJECT:return this.templateManager.render("chooseobject");case this.STEP_SCREENSIZE_ENTER_OBJECTSIZE:return this.templateManager.render("specifystandardsize");case this.STEP_BRIGHTNESS:return this.templateManager.render("setbrightness");case this.STEP_SUMMARY:return this.templateManager.render("summary",{diagonalSize:this.diagonalSize.toFixed(this.FLOAT_PRECISION),diagonalSizeInPx:Math.ceil(this.diagonalSizeInPx),pixelsPerDegree:this.pixelsPerDegree.toFixed(this.FLOAT_PRECISION),pixelsPerInch:this.pixelsPerInch.toFixed(this.FLOAT_PRECISION)})}}},{key:"diagonalSize",set:function(t){return null==t?void(this._diagonalSize=null):(t=Number(t),void(t>0&&t<60?this._diagonalSize=t:console.log("Calibrator.js: Invalid diagonal size")))},get:function(){return this._diagonalSize?this._diagonalSize:null}},{key:"diagonalSizeInCm",get:function(){return this.diagonalSize?2.54*this.diagonalSize:null}},{key:"diagonalSizeInPx",get:function(){return Math.sqrt(Math.pow(screen.availWidth,2)+Math.pow(screen.availHeight,2))}},{key:"pixelsPerInch",get:function(){return this.diagonalSize?this.diagonalSizeInPx/this.diagonalSize:null}},{key:"pixelsPerCm",get:function(){return this.diagonalSize?this.pixelsPerInch/2.54:null}},{key:"pixelsPerDegree",get:function(){if(this.diagonalSize){var t=2*Math.atan(screen.availWidth/this.pixelsPerCm/(2*this.distanceFromScreen)),e=180/Math.PI;return screen.availWidth/(e*t)}return null}},{key:"imageRatio",set:function(t){t>=0&&t<=1&&(this._imageRatio=t,this.setDiagonalSizeFromRatio(),this.drawImage())},get:function(){return this._imageRatio}},{key:"currentImage",set:function(t){_.contains(this.IMAGES,t)&&(this._currentImage=t,this.updateCanvasHeight(),this.drawImage())},get:function(){return this._currentImage?this._currentImage:(console.log("Calibrator.js: currentImage is not set."),null)}},{key:"currentImagePhysicalWidthInCm",get:function(){return this.currentImage?this.IMAGES[this.currentImage][2]:null}},{key:"currentImagePhysicalWidthInInches",get:function(){return this.currentImage?this.IMAGES[this.currentImage][2]/2.54:null}},{key:"currentImageScaledHeightInPx",get:function(){return this.currentImage?this.IMAGES[this.currentImage][1][1]*this.IMAGES[this.currentImage][3]*this.imageRatio:null}},{key:"currentImageScaledWidthInPx",get:function(){return this.currentImage?this.IMAGES[this.currentImage][1][0]*this.IMAGES[this.currentImage][3]*this.imageRatio:null}}]),t}(),TemplateManager=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?mandatory():arguments[0],i=arguments.length<=1||void 0===arguments[1]?null:arguments[1];_classCallCheck(this,t),_.templateSettings={interpolate:/\{\{(.+?)\}\}/g},this.viewPaths=e,this.cached={},i?this.callbackWhenLoaded=i:this.callbackWhenLoaded=function(){console.log("TemplateManager.js: all templates loaded.")};var a=this;_.each(this.viewPaths,function(t,e,i){$.get(a.viewPaths[e],function(t){a.store(e,t),_.every(_.allKeys(a.viewPaths),function(t){return _.contains(_.allKeys(a.cached),t)})&&a.callbackWhenLoaded()})})}return _createClass(t,[{key:"render",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=this;return this.isCached(t)?this.cached[t](e):void $.get(this.urlFor(t),function(a){i.store(t,a),i.render(t,e)})}},{key:"renderInTarget",value:function(t,e,i){var a=this;this.isCached(t)?$(i).append(this.cached[t](e)):$.get(this.urlFor(t),function(n){a.store(t,n),a.renderInTarget(t,e,i)})}},{key:"renderSync",value:function(t){this.isCached(t)||this.fetch(t),this.render(t)}},{key:"prefetch",value:function(t){var e=this;$.get(this.urlFor(t),function(i){e.store(t,i)})}},{key:"fetch",value:function(t){if(!this.isCached(t)){var e=$.ajax({url:this.urlFor(t),async:!1}).responseText;this.store(t,e)}}},{key:"isCached",value:function(t){return!!this.cached[t]}},{key:"store",value:function(t,e){this.cached[t]=_.template(e)}},{key:"urlFor",value:function(t){return this.viewPaths[t]}}]),t}();